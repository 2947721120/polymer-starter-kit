<link rel="import" href="../polymer/polymer.html"><link rel="import" href="breakpoint-rule.html"><script src="breakpoint-control-behavior.js"></script><script>
(function() {
  'use strict';

  function domTraversal(root, fn) {
    if (root === null) {
      return;
    }

    var i, current, children;
    var queue = [root];

    while (queue.length > 0) {
      fn(current = queue.pop());
      children = Polymer.dom(current).children;
      for (i = 0; i < children.length; i++) {
        queue.push(children[i]);
      }
    }
  }

  var breakpointContext = {
    queryManager: {},
    breakpoints: [],
    activeBreakpoint: ''
  };

  Polymer({

    is: 'breakpoint-control',

    behaviors: [Polymer.Core.BreakpointControl],

    properties: {
      target: {
        type: String,
        value: 'html',
        notify: true
      },

      breakpoint: {
        type: String,
        value: '',
        readOnly: true,
        notify: true
      }
    },

    ready: function() {
      this.async(this._setRules);
    },

    created: function() {
      this._setListener(this._breakpointListener.bind(this));
      this._setContext(breakpointContext);
    },

    _setRules: function() {
      var ruleElements = Polymer.dom(this).querySelectorAll('breakpoint-rule');
      var breakpointQuery, ruleElement, breakpoints = {};

      for (var i = 0; i < ruleElements.length; i++) {
        ruleElement =  ruleElements[i];
        breakpointQuery = this.all();

        if (ruleElement.platform !== '') {
          switch (ruleElement.platform) {
            case 'desktop':
              breakpointQuery = breakpointQuery.desktop();
            break;
            case 'phone':
            case 'mobile':
              breakpointQuery = breakpointQuery.phone();
            break;
            case 'tablet':
              breakpointQuery = breakpointQuery.tablet();
            break;
            case 'tv':
              breakpointQuery = breakpointQuery.tv();
            break;
            default:
              console.error('[breakpoint-control] %s is not a value for platform',
                  ruleElement.platform);
            break;
          }
        }

        if (ruleElement.orientation !== '') {
          switch (ruleElement.orientation) {
            case 'portrait':
              breakpointQuery = breakpointQuery.portrait();
            break;
            case 'landscape':
              breakpointQuery = breakpointQuery.landscape();
            break;
            default:
              console.error('[breakpoint-control] %s is not a value for orientation',
                  ruleElement.orientation);
            break;
          }
        }

        breakpointQuery = breakpointQuery
            .min(ruleElement.minWidth)
            .max(ruleElement.maxWidth)
            .minRatio(ruleElement.minRatio)
            .maxRatio(ruleElement.maxRatio);
  
        breakpoints[ruleElements[i].name] = breakpointQuery;
      }

      this._registerBreakpoints(breakpoints);
    },

    _dispatchEvent: function(target, breakpoint) {
      this.fire('breakpointChanged',
        {
          breakpoint: breakpoint
        },
        {
          node: target,
          bubbles: true
      });
    },

    _breakpointListener: function(breakpoint) {
      var targetElement = document.querySelector(this.target);

      if (targetElement === null || this.breakpoint === breakpoint) {
        return;
      }

      // TO-DO: remove this try block once this issue gets fixed
      try {
        if (this.breakpoint) {
          targetElement.classList.remove(this.breakpoint);
        }
        this._setBreakpoint(breakpoint);
      } catch (e) {
        this.properties.breakpoint.value = breakpoint;
      }

      targetElement.classList.add(breakpoint);

      // TO-DO: remove this once updateStyles gets called automatically
      domTraversal(document.body, function(element) {
        if ('updateStyles' in element) {
          element.enableCustomStyleProperties = true;
          element.updateStyles();
        }
      });

      this._dispatchEvent(targetElement, breakpoint);
    }
  });

})();
</script>